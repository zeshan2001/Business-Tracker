{% extends "baseBusinessOwner.html" %} {% block content %} {% load humanize %}

<div class="business-detail-container">
  <!-- Business Basic Info -->
  <div class="business-info-card">
    <div class="business-image-container">
      {% load static %}
      <img
        src="{% static business.image|cut:'main_app/static' %}"
        alt="brand image"
      />
    </div>
    <div class="bb-det">
      <h2>{{ business.brand }}</h2>
      <p><strong>Owner:</strong> {{ business.user.username }}</p>
      <p>
        <strong>Initial Cost:</strong> ${{ business.init_cost|floatformat:2|intcomma }}
      </p>
      <p>{{ business.description }}</p>
    </div>
  </div>

  <!-- Add Financial Statements Buttons -->
  <div class="balance-income-buttons-container">
    <div class="btn-balance-income">
      <a href="{% url 'income_statement' business.id %}" class="">
        ‚ûï Income Statement
      </a>
    </div>
    <div class="btn-balance-income">
      <a href="{% url 'balance_sheet' business.id %}" class="bbttnn">
        ‚ûï Balance Sheet
      </a>
    </div>
  </div>

  <div class="financial-tables-container">
    <!-- Balance Sheet Table -->
    <div class="table-container">
      {% if balance_sheets %}
      <h3>Balance Sheet</h3>
      <table class="">
        <thead>
          <tr>
            <th>Years</th>
            {% for sheet in balance_sheets %}
            <th>
              <a href="{% url 'balance_sheet_Delete' sheet.id %}">‚ùå</a>
              {{ sheet.year }}
              <a href="{% url 'balance_sheet_Update' sheet.id %}">üìù</a>
            </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Current Assets</strong></td>
            {% for sheet in balance_sheets %}
            <td>${{ sheet.current_assets|floatformat:2|intcomma }}</td>
            {% endfor %}
          </tr>
          <tr>
            <td><strong>Non-Current Assets</strong></td>
            {% for sheet in balance_sheets %}
            <td>${{ sheet.non_current_assets|floatformat:2|intcomma }}</td>
            {% endfor %}
          </tr>
          <tr>
            <td><strong>Cash & Equivalents</strong></td>
            {% for sheet in balance_sheets %}
            <td>${{ sheet.cash_equivalents|floatformat:2|intcomma }}</td>
            {% endfor %}
          </tr>
          <tr>
            <td><strong>Current Liabilities</strong></td>
            {% for sheet in balance_sheets %}
            <td>${{ sheet.current_liabilities|floatformat:2|intcomma }}</td>
            {% endfor %}
          </tr>
          <tr>
            <td><strong>Non-Current Liabilities</strong></td>
            {% for sheet in balance_sheets %}
            <td>${{ sheet.non_current_liabilities|floatformat:2|intcomma }}</td>
            {% endfor %}
          </tr>
          <tr>
            <td><strong>Shareholders Equity</strong></td>
            {% for sheet in balance_sheets %}
            <!-- <td>${{ sheet.shareholders_equity|floatformat:2|intcomma }}</td> -->
            {% if sheet.shareholders_equity < 0 %}
            <td style="color: red">
              (${{ sheet.shareholders_equity|floatformat:2|intcomma|slice:'1:' }})
            </td>
            {% else %}
            <td>${{ sheet.shareholders_equity|floatformat:2|intcomma }}</td>
            {% endif %}
            {% endfor %}
          </tr>
        </tbody>
      </table>
      {% else %}
      <p>No balance sheets available.</p>
      {% endif %}
    </div>

    <!-- Income Statement Table -->
    <div class="table-container">
      {% if income_statements %}
      <h3>Income Statement</h3>
      <table>
        <thead>
          <tr>
            <th>Years</th>
            {% for statement in income_statements %}
            <th>
              <a href="{% url 'income_statement_delete' statement.id %}">‚ùå</a>
              {{ statement.year }}
              <a href="{% url 'income_statement_update' statement.id %}">üìù</a>
            </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Revenue</strong></td>
            {% for statement in income_statements %}
            <td>${{ statement.revenue|floatformat:2|intcomma }}</td>
            {% endfor %}
          </tr>
          <tr>
            <td><strong>Non Cash Expense</strong></td>
            {% for statement in income_statements %}
            <td>${{ statement.non_cash_expense|floatformat:2|intcomma }}</td>
            {% endfor %}
          </tr>
          <tr>
            <td><strong>Cost of Goods Sold</strong></td>
            {% for statement in income_statements %}
            <td>${{ statement.cogs|floatformat:2|intcomma }}</td>
            {% endfor %}
          </tr>
          <tr>
            <td><strong>Operating Expenses</strong></td>
            {% for statement in income_statements %}
            <td>${{ statement.operating_expenses|floatformat:2|intcomma }}</td>
            {% endfor %}
          </tr>
          <tr>
            <td><strong>Net Income</strong></td>
            {% for statement in income_statements %} 
            {% if statement.net_income < 0 %}
            <td style="color: red">
              (${{ statement.net_income|floatformat:2|intcomma|slice:'1:' }})
            </td>
            {% else %}
            <td>${{ statement.net_income|floatformat:2|intcomma }}</td>
            {% endif %} 
            {% endfor %}
          </tr>
        </tbody>
      </table>
      {% else %}
      <p>No income statements available.</p>
      {% endif %}
    </div>
  </div>
</div>

<div class="pie-npv-charts-container">
  <!-- Pie Chart -->
  <div>
    <h2 class="ffscdr" align="center">Cost</h2>
    <canvas id="pieChart" width="400" height="200"></canvas>
  </div>
  <!-- NPV Chart -->
  <div>
    <h2 class="ffscdr" align="center">NPV</h2>
      {% if is_loss %}
        <p class="ffscdr">not predictable, out of data</p>
      {% else %}
      <canvas id="npvChart" width="600" height="400"></canvas>  
      {% endif %}      
  </div>
</div>

<script>
  // Pie Chart
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: {{ pie_labels|safe }},
      datasets: [{
        label: 'Cost Distribution',
        data: {{ pie_data|safe }},
        backgroundColor: [
          'rgba(255, 99, 132, 0.7)',
          'rgba(54, 162, 235, 0.7)',
          'rgba(255, 206, 86, 0.7)',
          'rgba(75, 192, 192, 0.7)'
        ],
        borderColor: [
          'rgba(255, 99, 132, 1)',
          'rgba(54, 162, 235, 1)',
          'rgba(255, 206, 86, 1)',
          'rgba(75, 192, 192, 1)'
        ],
        borderWidth: 1
      }]
    }
  });


  const ctx = document.getElementById('npvChart').getContext('2d');
  const discountRates = {{ discount_rates|safe }};
  const npvValues = {{ npv_values|safe }};
  const irrRate = ({{ irr|safe }} * 100) / 5;
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: discountRates,
      datasets: [{
          label: 'NPV Curve',
          data: npvValues.reverse(),
          borderColor: 'blue',
          borderWidth: 2,
          fill: false,
          tension: 0.2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        annotation: {
          annotations: {
            zeroLine: {
                type: 'line',
                yMin: 0,
                yMax: 0,
                borderColor: 'black',
                borderWidth: 1
            },
            irrLine: {
              type: 'line',
              xMin: irrRate,
              xMax: irrRate,
              borderColor: 'red',
              borderDash: [6, 6],
              borderWidth: 2,
              label: {
                enabled: true,
                content: 'IRR ‚âà ' + irrRate.toFixed(2) + '%',
                position: 'start',
                backgroundColor: 'rgba(255,255,255,0.7)',
                color: 'red'
              }
            }
          }
        }
      },
      scales: {
        x: { title: { display: true, text: 'Discount Rate (%)' } },
        y: { title: { display: true, text: 'NPV ($)' } }
      }
    }
  });
</script>
{% endblock %}
